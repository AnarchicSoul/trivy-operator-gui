name: Package and Publish Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'helm/**'
      - '.github/workflows/helm-package-push.yml'
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  package-and-release:
    name: Package and Release Helm Chart
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Extract version
        id: version
        run: |
          # Extract version from Chart.yaml
          CHART_VERSION=$(grep '^version:' helm/trivy-operator-gui/Chart.yaml | awk '{print $2}')
          echo "chart_version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $CHART_VERSION"

      - name: Package Helm chart
        run: |
          mkdir -p .cr-release-packages
          helm package helm/trivy-operator-gui -d .cr-release-packages
          echo "Packaged chart:"
          ls -lh .cr-release-packages/

      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages || git checkout --orphan gh-pages

      - name: Copy packaged chart
        run: |
          mkdir -p charts
          cp .cr-release-packages/*.tgz charts/

      - name: Generate Helm repository index
        run: |
          helm repo index charts --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts

      - name: Create index.html
        run: |
          cat > charts/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>Trivy Operator GUI Helm Charts</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  h1 { color: #333; }
                  pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                  code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
              </style>
          </head>
          <body>
              <h1>Trivy Operator GUI Helm Charts</h1>
              <p>This repository hosts Helm charts for Trivy Operator GUI.</p>

              <h2>Add Repository</h2>
              <pre>helm repo add trivy-operator-gui https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts
          helm repo update</pre>

              <h2>Install Chart</h2>
              <pre>helm install trivy-operator-gui trivy-operator-gui/trivy-operator-gui \\
            --namespace trivy-system \\
            --create-namespace</pre>

              <h2>Available Charts</h2>
              <ul>
          EOF

          for chart in charts/*.tgz; do
            if [ -f "$chart" ]; then
              chart_name=$(basename "$chart")
              echo "        <li><a href=\"$chart_name\">$chart_name</a></li>" >> charts/index.html
            fi
          done

          cat >> charts/index.html <<EOF
              </ul>

              <h2>Documentation</h2>
              <p>Visit the <a href="https://github.com/${{ github.repository }}">GitHub repository</a> for full documentation.</p>
          </body>
          </html>
          EOF

      - name: Commit and push to gh-pages
        run: |
          git add charts/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Helm chart repository - version ${{ steps.version.outputs.chart_version }}"
            git push origin gh-pages
          fi

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: .cr-release-packages/*.tgz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Package Summary
    runs-on: ubuntu-latest
    needs: [package-and-release]
    if: always()

    steps:
      - name: Display summary
        run: |
          echo "## Helm Chart Published ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Repository URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Add Repository:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm repo add trivy-operator-gui https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts" >> $GITHUB_STEP_SUMMARY
          echo "helm repo update" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm install trivy-operator-gui trivy-operator-gui/trivy-operator-gui --namespace trivy-system --create-namespace" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
