name: Package and Publish Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'helm/**'
      - '.github/workflows/helm-package-push.yml'
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package-and-push:
    name: Package and Push Helm Chart to Docker Hub
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | helm registry login registry-1.docker.io \
            --username ${{ secrets.DOCKERHUB_USERNAME }} \
            --password-stdin

      - name: Extract version
        id: version
        run: |
          # Extract version from Chart.yaml
          CHART_VERSION=$(grep '^version:' helm/trivy-operator-gui/Chart.yaml | awk '{print $2}')
          echo "chart_version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $CHART_VERSION"

      - name: Package Helm chart
        run: |
          mkdir -p .helm-package
          helm package helm/trivy-operator-gui -d .helm-package
          echo "Packaged chart:"
          ls -lh .helm-package/

      - name: Push chart to Docker Hub OCI
        run: |
          CHART_FILE=$(ls .helm-package/*.tgz)
          echo "Pushing $CHART_FILE to Docker Hub..."
          helm push $CHART_FILE oci://registry-1.docker.io/${{ secrets.DOCKERHUB_USERNAME }}
          echo "âœ… Chart pushed successfully!"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: .helm-package/*.tgz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Push Summary
    runs-on: ubuntu-latest
    needs: [package-and-push]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          CHART_VERSION=$(grep '^version:' helm/trivy-operator-gui/Chart.yaml | awk '{print $2}')
          echo "chart_version=$CHART_VERSION" >> $GITHUB_OUTPUT

      - name: Display summary
        run: |
          echo "## Helm Chart Published to Docker Hub ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Version:** ${{ steps.version.outputs.chart_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** Docker Hub OCI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install Chart:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm install trivy-operator-gui \\" >> $GITHUB_STEP_SUMMARY
          echo "  oci://registry-1.docker.io/${{ secrets.DOCKERHUB_USERNAME }}/trivy-operator-gui \\" >> $GITHUB_STEP_SUMMARY
          echo "  --version ${{ steps.version.outputs.chart_version }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --namespace trivy-system \\" >> $GITHUB_STEP_SUMMARY
          echo "  --create-namespace" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Chart:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm pull oci://registry-1.docker.io/${{ secrets.DOCKERHUB_USERNAME }}/trivy-operator-gui --version ${{ steps.version.outputs.chart_version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

