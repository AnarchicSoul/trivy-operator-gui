package models

import (
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// VulnerabilityReport represents the Trivy Operator VulnerabilityReport CRD
type VulnerabilityReport struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`
	Report            Report `json:"report"`
}

// Report contains the vulnerability scan report details
type Report struct {
	UpdateTimestamp metav1.Time     `json:"updateTimestamp"`
	Scanner         Scanner         `json:"scanner"`
	Registry        Registry        `json:"registry"`
	Artifact        Artifact        `json:"artifact"`
	Summary         Summary         `json:"summary"`
	Vulnerabilities []Vulnerability `json:"vulnerabilities"`
}

// Scanner information
type Scanner struct {
	Name    string `json:"name"`
	Vendor  string `json:"vendor"`
	Version string `json:"version"`
}

// Registry information
type Registry struct {
	Server string `json:"server"`
}

// Artifact represents the scanned container image
type Artifact struct {
	Repository string `json:"repository"`
	Digest     string `json:"digest,omitempty"`
	Tag        string `json:"tag,omitempty"`
}

// Summary contains vulnerability counts by severity
type Summary struct {
	CriticalCount int `json:"criticalCount"`
	HighCount     int `json:"highCount"`
	MediumCount   int `json:"mediumCount"`
	LowCount      int `json:"lowCount"`
	UnknownCount  int `json:"unknownCount"`
	NoneCount     int `json:"noneCount"`
}

// Vulnerability represents a single vulnerability finding
type Vulnerability struct {
	VulnerabilityID  string   `json:"vulnerabilityID"`
	Resource         string   `json:"resource"`
	InstalledVersion string   `json:"installedVersion"`
	FixedVersion     string   `json:"fixedVersion"`
	PublishedDate    string   `json:"publishedDate,omitempty"`
	LastModifiedDate string   `json:"lastModifiedDate,omitempty"`
	Severity         string   `json:"severity"`
	Title            string   `json:"title"`
	PrimaryLink      string   `json:"primaryLink,omitempty"`
	Links            []string `json:"links,omitempty"`
	Score            *float64 `json:"score,omitempty"`
	Target           string   `json:"target,omitempty"`
	Class            string   `json:"class,omitempty"`
	PackageType      string   `json:"packageType,omitempty"`
}

// VulnerabilityReportList represents a list of VulnerabilityReports
type VulnerabilityReportList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata,omitempty"`
	Items           []VulnerabilityReport `json:"items"`
}

// ConfigAuditReport represents the Trivy Operator ConfigAuditReport CRD
type ConfigAuditReport struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`
	Report            ConfigReport `json:"report"`
}

// ConfigReport contains the configuration audit report details
type ConfigReport struct {
	UpdateTimestamp metav1.Time `json:"updateTimestamp"`
	Scanner         Scanner     `json:"scanner"`
	Summary         CheckSummary `json:"summary"`
	Checks          []Check     `json:"checks,omitempty"`
}

// CheckSummary contains check counts by severity
type CheckSummary struct {
	CriticalCount int `json:"criticalCount"`
	HighCount     int `json:"highCount"`
	MediumCount   int `json:"mediumCount"`
	LowCount      int `json:"lowCount"`
}

// Check represents a configuration audit check result
type Check struct {
	ID          string   `json:"checkID"`
	Title       string   `json:"title"`
	Description string   `json:"description,omitempty"`
	Severity    string   `json:"severity"`
	Category    string   `json:"category"`
	Success     bool     `json:"success"`
	Messages    []string `json:"messages,omitempty"`
	Remediation string   `json:"remediation,omitempty"`
}

// ConfigAuditReportList represents a list of ConfigAuditReports
type ConfigAuditReportList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata,omitempty"`
	Items           []ConfigAuditReport `json:"items"`
}

// DashboardSummary aggregates all reports for the dashboard
type DashboardSummary struct {
	TotalPods              int                    `json:"totalPods"`
	TotalVulnerabilities   int                    `json:"totalVulnerabilities"`
	TotalConfigIssues      int                    `json:"totalConfigIssues"`
	VulnerabilitySummary   Summary                `json:"vulnerabilitySummary"`
	ConfigIssueSummary     CheckSummary           `json:"configIssueSummary"`
	RecentReports          []ReportSummary        `json:"recentReports"`
	PodsByNamespace        map[string]int         `json:"podsByNamespace"`
	VulnerabilitiesBySeverity map[string]int      `json:"vulnerabilitiesBySeverity"`
}

// ReportSummary provides a condensed view of a report
type ReportSummary struct {
	Name            string      `json:"name"`
	Namespace       string      `json:"namespace"`
	Kind            string      `json:"kind"`
	ContainerName   string      `json:"containerName"`
	UpdateTimestamp metav1.Time `json:"updateTimestamp"`
	Summary         Summary     `json:"summary"`
	ImageName       string      `json:"imageName"`
}

// PodReports groups all reports for a specific pod
type PodReports struct {
	PodName              string                  `json:"podName"`
	Namespace            string                  `json:"namespace"`
	VulnerabilityReports []VulnerabilityReport   `json:"vulnerabilityReports"`
	ConfigAuditReports   []ConfigAuditReport     `json:"configAuditReports"`
	TotalVulnerabilities int                     `json:"totalVulnerabilities"`
	TotalConfigIssues    int                     `json:"totalConfigIssues"`
	VulnerabilitySummary Summary                 `json:"vulnerabilitySummary"`
	ConfigIssueSummary   CheckSummary            `json:"configIssueSummary"`
}

// CategoryReport groups vulnerabilities by severity
type CategoryReport struct {
	Severity        string                  `json:"severity"`
	Count           int                     `json:"count"`
	Vulnerabilities []VulnerabilityDetail   `json:"vulnerabilities"`
}

// VulnerabilityDetail combines vulnerability info with its source
type VulnerabilityDetail struct {
	Vulnerability
	PodName       string `json:"podName"`
	Namespace     string `json:"namespace"`
	ContainerName string `json:"containerName"`
	ImageName     string `json:"imageName"`
}
